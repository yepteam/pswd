<!doctype html>

<html lang="en" class="h-100">
  <head>
    <title>PSWD — anonymous generator of strong passwords.</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="//cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/bootstrap-icons@1.6.1/font/bootstrap-icons.css">
  </head>


  <body class="h-100">

  <div class="p-1 h-100 d-flex flex-column justify-content-center">
    <div class="container">
      <div class="row">
        <div class="col-md-9 col-lg-7 col-xl-5 mx-auto text-center">
            
          <div class="input-group mb-3 mb-md-4 mb-xl-5">

            <h1 class="fw-bold mb-0 me-2">PSWD</h1>

            <select class="form-control form-select" id="strength">
              <option value="8">WEAK 8</option>
              <option value="16" selected>NORMAL 16</option>
              <option value="24">STRONG 24</option>
              <option value="32">HELL 32</option>
            </select>
            
            <button class="btn btn-danger" type="button" id="generate" onclick="generate(); return false;">
              <i class="bi bi-arrow-clockwise"></i> GENERATE
            </button>
            
          </div>
          
        </div>
      </div>
      <div class="row">
        <div class="col-md-12 col-lg-10 col-xl-8 mx-auto text-center">
          
          
          <div class="input-group mb-3 mb-md-4 mb-xl-5">
            
            <input id="pswd" class="form-control fs-2 font-monospace" type="text" placeholder="PASSWORD" readonly>
            <button class="btn btn-primary fs-2" type="button" id="copy" onclick="copy(); return false;">
              <span class="px-1">
                <i class="bi bi-files"></i><span class="d-none d-md-inline"> COPY </span>
              </span>
            </button>
        
            
          </div>
          <a class="btn btn-outline-light btn-sm mb-2" href="//github.com/yepteam/pswd" target="_blank"><i class="bi bi-github"></i> GITHUB </a>

          
        </div>
          
         
      </div>
    </div>
  </div>


  <script>
    
  function copy() {
    var text = document.querySelector('#pswd');
    text.focus();
    text.select();

    try {
      var successful = document.execCommand('copy');
      var msg = successful ? 'successful' : 'unsuccessful';
      //console.log('Copying text command was ' + msg);
    } 
    catch (err) {
      //console.log('Oops, unable to copy');
    }
  }


  function generate() {
    let strength = document.getElementById('strength').value;

    /**
     * @param {number} length - Длина пароля
     * @param {boolean} strictMode - Строгий режим (true) избегает всех паттернов
     * @returns {string} Сгенерированный пароль
     */
    function generateCryptoPassword(length = 16, strictMode = true) {
      const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const lowercase = 'abcdefghijklmnopqrstuvwxyz';
      const numbers = '0123456789';
      const symbols = '!@#$%^&*';
      const allChars = uppercase + lowercase + numbers + symbols;

      function getCryptoRandomInt(max) {
        const randomBuffer = new Uint32Array(1);
        window.crypto.getRandomValues(randomBuffer);
        return randomBuffer[0] % max;
      }

      let password = '';
      const maxAttemptsPerChar = 50;

      const usedChars = new Set();
      const usedLowercase = new Set();

      const keyboardPatterns = ['qwerty', 'asdfgh', 'zxcvbn', '123456', 'password', 'admin'];

      const requiredTypes = [
        uppercase[getCryptoRandomInt(uppercase.length)],
        lowercase[getCryptoRandomInt(lowercase.length)],
        numbers[getCryptoRandomInt(numbers.length)],
        symbols[getCryptoRandomInt(symbols.length)]
      ];

      for (let i = requiredTypes.length - 1; i > 0; i--) {
        const j = getCryptoRandomInt(i + 1);
        [requiredTypes[i], requiredTypes[j]] = [requiredTypes[j], requiredTypes[i]];
      }

      for (const char of requiredTypes.slice(0, Math.min(4, length))) {
        password += char;
        if (strictMode) {
          usedChars.add(char.toLowerCase());
          if (/[a-z]/.test(char)) usedLowercase.add(char.toLowerCase());
        }
      }

      for (let i = password.length; i < length; i++) {
        let char;
        let valid = false;
        let charAttempts = 0;

        while (!valid && charAttempts < maxAttemptsPerChar) {
          char = allChars[getCryptoRandomInt(allChars.length)];
          charAttempts++;

          if (!strictMode) {
            valid = true;
            break;
          }

          if (usedChars.has(char.toLowerCase())) {
            continue;
          }

          if (i > 0) {
            const prevChar = password[i - 1];

            const bothDigits = /\d/.test(char) && /\d/.test(prevChar);

            const bothSameCase =
                    (/[A-Z]/.test(char) && /[A-Z]/.test(prevChar)) ||
                    (/[a-z]/.test(char) && /[a-z]/.test(prevChar));

            const bothSymbols = /[!@#$%^&*]/.test(char) && /[!@#$%^&*]/.test(prevChar);

            if (bothDigits || bothSameCase || bothSymbols) {
              continue;
            }
          }

          if (/[a-zA-Z]/.test(char)) {
            const lowerChar = char.toLowerCase();
            if (usedLowercase.has(lowerChar)) {
              continue;
            }
          }

          valid = true;
        }

        if (!valid) {
          char = allChars[getCryptoRandomInt(allChars.length)];
        }

        password += char;

        if (strictMode) {
          usedChars.add(char.toLowerCase());
          if (/[a-z]/.test(char)) {
            usedLowercase.add(char.toLowerCase());
          }
        }
      }

      if (strictMode) {
        const passLower = password.toLowerCase();
        for (const pattern of keyboardPatterns) {
          if (passLower.includes(pattern)) {
            return generateUICPassword(length, strictMode);
          }
        }
      }

      return password;
    }

    let result = generateCryptoPassword(strength);
    document.getElementById('pswd').value = result;
    return result;
  }
    
  function onchange(e) {
   generate();
  }

  generate();
    
  document.getElementById('strength').addEventListener('change', onchange);

  </script>

  </body>
</html>
